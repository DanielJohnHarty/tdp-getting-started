---
- name: Create users principals
  hosts: kdc
  become: yes
  tasks:
    - name: Create user principal
      become: yes
      shell: |
        kadmin -r {{ realm }} -p {{ kadmin_principal }} -w {{ kadmin_password }} -q "addprinc -randkey {{ item.username }}@{{ realm }}"
      with_items: "{{ users }}"

- name: Create users
  hosts: all
  become: yes
  tasks:
    - name: Create Unix user
      user:
        name: "{{ item.username }}"
        home: "/home/{{ item.username }}/"
        password: '{{ "{{ item.password }}" | password_hash("sha512", "salt123") }}'
      with_items: "{{ users }}"

    - name: Create ~/.keytabs directory
      file:
        path: "/home/{{ item.username }}/.keytabs/"
        state: directory
      with_items: "{{ users }}"

    - name: Generate user keytab
      become: yes
      shell: |
        kadmin -r {{ realm }} -p {{ kadmin_principal }} -w {{ kadmin_password }} -q "xst -k {{ item.username }}.principal.keytab {{ item.username }}@{{ realm }}"
        chown {{ item.username }}:{{ item.username }} {{ item.username }}.principal.keytab
      args:
        chdir: /home/{{ item.username }}/.keytabs/
        creates: /home/{{ item.username }}/.keytabs/{{ item.username }}.principal.keytab
      with_items: "{{ users }}"

- name: Create users HDFS directories
  hosts: hdfs_nn[0]
  become: yes
  tasks:
    - name: Kinit as hdfs
      become: yes
      become_user: "{{ hdfs_user }}"
      command: "kinit -kt /etc/security/keytabs/nn.service.keytab nn/{{ groups['hdfs_nn'][0] | tosit.tdp.access_fqdn(hostvars) }}@{{ realm }}"

    - name: Create home folder in HDFS
      become: yes
      become_user: "{{ hdfs_user }}"
      tosit.tdp.hdfs_file:
        hdfs_conf: "{{ hadoop_conf_dir }}"
        path: "/user/{{ item.username }}"
        state: directory
        owner: "{{ item.username }}"
        group: "{{ item.username }}"
        mode: "755"
      loop: "{{ users }}"

- name: Create users in Ranger
  hosts: ranger_admin[0]
  become: yes
  tasks:
    - include_role:
        name: ansible_roles/roles/ansible-tdp-common-actions
        tasks_from: deploy-new-ranger-user
      with_items:
        - "{{ users }}"

- name: Create HDFS access policies in Ranger
  hosts: ranger_admin[0]
  become: yes
  tasks:
    - include_role:
        name: ansible_roles/roles/ansible-tdp-common-actions
        tasks_from: deploy-ranger-hdfs-policy
      with_items:
        - "{{ user_hdfs_policies }}"

- name: Create Hive access policies in Ranger
  hosts: ranger_admin[0]
  become: yes
  tasks:
    - include_role:
        name: ansible_roles/roles/ansible-tdp-common-actions
        tasks_from: deploy-ranger-hive-policy
      with_items:
        - "{{ user_hive_policies }}"
